(function($) {
	var normalize = (function() {
		var from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç",
		to   = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc",
		mapping = {};
 
		for(var i = 0, j = from.length; i < j; i++ )
			mapping[ from.charAt( i ) ] = to.charAt( i );
 
		return function( str ) {
			var ret = [];
			for( var i = 0, j = str.length; i < j; i++ ) {
				var c = str.charAt( i );
				if( mapping.hasOwnProperty( str.charAt( i ) ) )
					ret.push( mapping[ c ] );
				else
					ret.push( c );
			}
			return ret.join( '' );
		}
 
		})();
	
	pageCant = 10;
	
	$.loadFilter = function(param) {
		
		var state = param.state;
		var district = param.district;
		var sport = param.sport;
		var ground = param.ground;
		var hour = param.hour;
		var day = param.day;
		var queryParam = '?state=' + state + '&district=' + district + '&sport=' + sport + '&ground=' + ground + '&hour=' + hour + '&day=' + day;
		_isScrolledIntoView = function(elem){
			var docViewTop = $(window).scrollTop();
			var docViewBottom = docViewTop + $(window).height();
			var elemTop = $(elem).offset().top;
			var elemBottom = elemTop + $(elem).height();

			return (elemBottom <= docViewBottom);
		};
		
		_processTemplate = function(response) {
			
			var data;
			var loading = false;
			var page = 1;
			$.template("filterTemplate", response);
			$("#sidebar").html(
			$.tmpl("filterTemplate", data, {}));
			
			$(window).scroll(function () {	
				if(_isScrolledIntoView($("#results")) && !loading && (pageCant > page)) {
					page = parseInt(page) + 1;
					loading = true;
					$("#results").append("<span id='loading"+ page.toString() +" style='display:block;height:30px'></span>");
					setTimeout(function () {loading = false; $("#loading" + page).css({"display" : "none"});}, 2000);
					$.loadSerchResults(queryParam, page.toString());
				}
			});
			
		}
		
		$.ajax({
			url: 'html/filter.php?state=' + state + '&district=' + district + '&sport=' + sport + '&ground=' + ground + '&hour=' + hour + '&day=' + day,
			type: 'html',
			success: _processTemplate
		});
	
	};
	
	$.loadLoginDialog = function() {
		
		
		_processTemplate = function(response) {
			var data;
			$.template("loginDialogTemplate", response);
			$("#login-dialog").html(
			$.tmpl("loginDialogTemplate", data, {}));
			
			$( "#login-dialog" ).dialog({
				modal: true,
				resizable: false,
				draggable: false,
				height: '500',
				width: '700',
				position: 'center',
				buttons: {
					Ok: function() {
						$( this ).dialog( "close" );
					}		
				}
			});
			
			$('.ui-widget-overlay').on("click", function() {
				$("#login-dialog").dialog("close");
			});
			
		}
		
		$.ajax({
			url: 'html/loginDialog.php',
			type: 'html',
			success: _processTemplate
		});
	
	};
	
	$.loadImagesDialog = function(idField) {
		
		
		_processTemplate = function(response) {
			var data;
			$.template("imagesDialogTemplate", response);
			$("#images-dialog").html(
			$.tmpl("imagesDialogTemplate", data, {}));
				
				
			
			$( "#images-dialog" ).dialog({
				modal: true,
				resizable: false,
				draggable: false,
				height: '500',
				width: '700',
				position: 'center'
			});
			
			$('.ui-widget-overlay').on("click", function() {
				$("#images-dialog").dialog("close");
				$("#images-dialog").html('');
			});
			
		}
		
		$.ajax({
			url: 'html/imagesDialog.php?idField=' + idField,
			type: 'html',
			success: _processTemplate
		});
	
	};
	
	$.loadBookConfirmationDialog = function() {
		
	
		
		_processTemplate = function(response) {
			var data;
			$.template("bookConfirmationDialogTemplate", response);
			$("#book-confirmation-dialog").html(
			$.tmpl("bookConfirmationDialogTemplate", data, {}));
			
			$( "#book-confirmation-dialog" ).dialog({
				modal: true,
				resizable: false,
				draggable: false,
				height: '500',
				width: '700',
				position: 'center'
			});
			
			$('.ui-widget-overlay').on("click", function() {
				$("#book-confirmation-dialog").dialog("close");
			});
			
		}
		
		$.ajax({
			url: 'html/bookConfirmation.php',
			type: 'html',
			success: _processTemplate
		});
	
	};
	
	$.loadSerchResults = function(param, page, pageCant2) {
		
		var state = param.state;
		var district = param.district;
		var sport = param.sport;
		var ground = param.ground;
		var hour = param.hour;
		var day = param.day;
		pageCant = pageCant2 !== undefined ? parseInt(pageCant2) : pageCant;
		
		_processTemplate = function(response) {
			var data;
			
			$.template("resultTemplate", response);
			$("#results").append(
			$.tmpl("resultTemplate", data, {}));		
		};
	
		$.ajax({
			url: 'html/serchRestults.php?state=' + state + '&district=' + district + '&sport=' + sport + '&ground=' + ground + '&hour=' + hour + '&day=' + day  + '&page=' + page,
			type: 'html',
			success: _processTemplate
		});
	};
		
	
	$.loadFeaturedFields = function(param) {
	
		var state = param.state;
		var sport = param.sport;

		
		_processTemplate = function(response) {
			var data;
			$.template("featuredFiedsTemplate", response);
			$("#serch").html(
			$.tmpl("featuredFiedsTemplate", data, {}));
			
		}
		
		$.ajax({
			url: 'html/featuredFields.php?state=' + state.replace(' ', '%20') + '&sport=' + sport.replace(' ', '%20'),
			type: 'html',
			success: _processTemplate
		});
	}

	$.loadMainFilter = function(param) {
	
		var state = param.state;
		var district = param.district;
		var sport = param.sport;
		var ground = param.ground;
		var hour = param.hour;
		var day = param.day;
		
		_processTemplate = function(response) {
			var data;
			$.template("mainFilterTemplate", response);
			$("#mainFilter").html(
			$.tmpl("mainFilterTemplate", data, {}));
			
			$('#mainFilter > ul').dropotron({ 
				offsetX: -2,
				offsetY: -8,
				mode: 'fade',
				noOpenerFade: true,
				hoverDelay: 0,
				hideDelay: 350,
				detach: false
			});
			
			if (sport != 'DEPORTE') {
				$('.backgroundSport').css({
					"background-image": "url('images/" + normalize(sport) + ".jpg')"
				});
			} 
			
			if (ground != 'SUELO' && ground != '') {
				$('.backgroundGround').css({
					"background-image": "url('images/" + normalize(sport) + '-' + normalize(ground) + ".jpg')"
				});
			} else {
				$('.backgroundGround').css({
					"background-image": "url('images/banner.jpg')"
				});
			}
			
		}
		
		$.ajax({
			url: 'html/mainFilter.php?state=' + state + '&district=' + district + '&sport=' + sport + '&ground=' + ground + '&hour=' + hour + '&day=' + day,
			type: 'html',
			success: _processTemplate
		});
	}
	
	$.loadHeader = function(param) {
		
		var state = param.state;
		var sport = param.sport;
	
		_processTemplate = function(response) {
			var data;
			$.template("headerTemplate", response);
			$("#nav").html(
			$.tmpl("headerTemplate", data, {}));
			
			$('#nav > ul').dropotron({ 
				offsetX: -2,
				offsetY: -8,
				mode: 'fade',
				noOpenerFade: true,
				hoverDelay: 0,
				hideDelay: 350,
				detach: false
			});
		}
	
		$.ajax({
			url: 'html/header.php?state=' + state.replace(' ', '%20') + '&sport=' + sport.replace(' ', '%20'),
			type: 'html',
			success: _processTemplate
		});
	}
	

})(jQuery);